# An Algorand Blackjack implementation with Beaker

## Overview

<!-- What is blackjack -->
Blackjack is the most widely played casino banking card game in the world.
<!-- Why not online blackjack -->
<!-- Why blackjack in blockchain -->
<!-- We use beaker -->

## Design

<!-- problema: nessuno deve conoscere il mazzo -->
<!-- problema: attore smette di interagire -->
<!-- server come dealer -->

## Implementation

### The state

* *asset*. The asset used for betting. This is the asset that will be transferred to the winner.
* *player*. The player's address.
* *fee_holder*. The address that will receive the fees.
* *bank*. The bank's address.
* *stake*. The amount of the asset that the player has staked.
* *nonce*. A random number that must be present in the player's request.
* *request*. A string generated by the player that determines what card will be drawn next.
* *cards*. The deck of cards.
* *last_card*. The last card that was drawn.
* *cards_left*. The number of cards left in the deck.
* *player_cards*. The cards that the player has.
* *player_min_total*. The minimum total of the player's cards based on the value of the ace.
* *player_max_total*. The maximum total of the player's cards based on the value of the ace.
* *bank_cards*. The cards that the bank has.
* *bank_min_total*. The minimum total of the bank's cards based on the value of the ace.
* *bank_max_total*. The maximum total of the bank's cards based on the value of the ace.
* *state*. The state of the game. It can be one of the following:
  * *init*. ...
  * *wait*. ...
  * *distribute*. ...
* *action_timer*. The round in which the last action was executed.
* *winner*. The winner√° address of the game.
* *fee_amount*. The amount of the asset that the fee holder will receive as a fee at the end of the game.

### Creating a blackjack match

An user can create a blackjack game by providing the asset to stake, the address of the bank, the address of the fee holder.

```py
@create
def create(self, asset: abi.Asset, bank: abi.Account, fee_holder: abi.Account):
    return Seq(
        self.asset.set(asset.asset_id()),
        self.bank.set(bank.address()),
        self.fee_holder.set(fee_holder.address()),
        self.cards.set(Bytes(b"\x00"*52)),
        self.cards_left.set(Int(52)),
        self.nonce.set(Int(0)),
        
        self.state.set(INIT),
    )
```
The create function initializes the deck, the actor adresses and the state.

### Defining the stake of the match

The player, after creating the contract, must call the `define_stake` function to set the amount of assets to bet. While setting this amount, the player must also pay that same amount to the contract. This payment must be made in units of the same token that was declared during creation.

```py
@internal
def define_stake(self, txn: abi.AssetTransferTransaction, fee_amount: abi.Uint64):
    return Seq(
        Assert(
            self.state.get() == POOR,
            Txn.sender() == Global.creator_address(),
            
            txn.get().xfer_asset() == self.asset.get(),
            txn.get().asset_receiver() == Global.current_application_address(),
        ),
        
        self.stake.set(txn.get().asset_amount()),
        self.fee_amount.set(fee_amount.get()),

        self.state.set(WAIT),
    )
```

The function sets the amount of the assets to bet, the fee amount to be paid by the player and the state.

## Bank joining the match

To start the game the bank has to join the contract with the `join_server` function. To do this the bank must send the same amount of assets that was previously defined by the player.

```py
@internal
def join_server(self, txn: abi.AssetTransferTransaction, fee_amount: abi.Uint64):
    return Seq(
        Assert(
            self.state.get() == WAIT,
            
            txn.get().sender() == self.bank.get(),
            txn.get().xfer_asset() == self.asset.get(),
            txn.get().asset_receiver() == Global.current_application_address(),
            txn.get().asset_amount() == self.stake.get(),
        ),

        self.fee_amount.set(fee_amount.get()),

        self.state.set(DISTRIBUTE),
        self.action_timer.set(Global.round()), 
    )
```

The function sets the fee amount to be paid by the bank, the action timer, and the state.



<!-- ... -->

init define stake join
tutte le altre
cancel finish forfeit give-funds-back

## Interazione
